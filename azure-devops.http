{{
    apiVersionParam = "api-version=7.1"
    apiVersionPreviewParam = "api-version=7.1-preview.3"
}}


# Get current iteration
# @name currentIteration
GET {{baseUrl}}/work/teamsettings/iterations?$timeframe=current&{{apiVersionParam}}
Authorization: Basic PAT {{token}}
{{
  iterationId = response.parsedBody.value[0].id
}}
?? status == 200
###
GET {{baseUrl}}/work/teamsettings/iterations/{{iterationId}}?{{apiVersionParam}}
Authorization: Basic PAT {{token}}

?? status == 200
###
# @disabled false
# User Story is an item with rel == null
GET {{baseUrl}}/work/teamsettings/iterations/{{iterationId}}/workitems?{{apiVersionParam}}
Authorization: Basic PAT {{token}}

?? status == 200
###
GET {{baseUrl}}/wit/workItems/1?$expand=Relations
Authorization: Basic PAT {{token}}
###
GET {{baseUrl}}/wit/workitems?ids=1&{{apiVersionParam}}&fields=System.Title,System.AreaPath,System.TeamProject,System.IterationPath
Authorization: Basic PAT {{token}}
###
GET {{baseUrl}}/wit/workitems?ids=1&{{apiVersionParam}}&$expand=Relations,Links
Authorization: Basic PAT {{token}}
###
GET {{baseUrl}}/wit/workitems?ids=2&{{apiVersionParam}}
Authorization: Basic PAT {{token}}
###
GET {{baseUrl}}/wit/classificationNodes/Areas?$depth=10&{{apiVersionParam}}
Authorization: Basic PAT {{token}}
###
GET {{baseUrl}}/wit/tags?{{apiVersionParam}}
Authorization: Basic PAT {{token}}
###
# @name GetTeam
# @desccription 
GET {{orgUrl}}/teams?{{apiVersionPreviewParam}}
Authorization: Basic PAT {{token}}

?? status == 200
{{
    team = response.parsedBody.value.filter((t) => t.projectName === projectName)[0]
    teamId = team.id
    projectId = team.projectId
}}

###
GET {{orgUrl}}/projects/{{projectId}}/teams/{{teamId}}/members?{{apiVersionParam}}
Authorization: Basic PAT {{token}}

?? status == 200
###
# @disabled 
# @description tests are done with an agile process so disabling it for now
GET {{orgUrl}}/projects/Scrum?{{apiVersionParam}}
Authorization: Basic PAT {{token}}
###
# @disabled 
# @description tests are done with an agile process so disabling it for now
GET {{orgUrl}}/projects/Scrum/teams/Scrum%20Team/members
Authorization: Basic PAT {{token}}
###
# @description return 404 even with api-version=5.1-preview.2
GET {{baseUrl}}/wit/workitemrelationtypes?api-version=5.1-preview.2
Authorization: Basic PAT {{token}}

?? status == 404
###
GET {{baseUrl}}/wit/workitemtypes/Task/fields/Microsoft.VSTS.Common.Activity?$expand=All&{{apiVersionParam}}
Authorization: Basic PAT {{token}}

?? status == 200
###
# Microsoft.VSTS.Scheduling.RemainingWork
# Microsoft.VSTS.Scheduling.OriginalEstimate

POST {{baseUrl}}/wit/workitems/$Task?{{apiVersionParam}}
Authorization: Basic PAT {{token}}
Content-Type: application/json-patch+json

[
	{
		"op": "add",
		"path": "/fields/System.Title",
		"value": "New sample task"
  	},
	{
		"op": "add",
		"path": "/fields/System.AreaPath",
		"value": "IDEAapp_2018"
  	},
	{
		"op": "add",
		"path": "/fields/System.TeamProject",
		"value": "IDEAapp_2018"
  	},
	{
		"op": "add",
		"path": "/fields/System.IterationPath",
		"value": "IDEAapp_2018\\Iteration 1"
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Common.Activity",
		"value": "Development"
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Scheduling.RemainingWork",
		"value": 7
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Scheduling.OriginalEstimate",
		"value": 7
  	},
	{
		"op": "add",
		"path": "/relations/-",
		"value": {
			"rel": "System.LinkTypes.Hierarchy-Reverse",
			"url": "https://dev.azure.com/ipatalas0593/_apis/wit/workItems/13"
		}
	}
]

# Add work item: https://docs.microsoft.com/en-us/rest/api/azure/devops/wit/work%20items/create?view=azure-devops-rest-5.0
# Add link https://docs.microsoft.com/en-us/rest/api/azure/devops/wit/work%20items/update?view=azure-devops-rest-5.0#add_a_link
###
# https://docs.microsoft.com/en-us/rest/api/azure/devops/wit/work%20items/update?view=azure-devops-rest-5.0
PATCH {{baseUrl}}/wit/workitems/2?{{apiVersionParam}}
Authorization: Basic PAT {{token}}
Content-Type: application/json-patch+json

[
	{
		"op": "add",
		"path": "/fields/System.Title",
		"value": "small task - edited"
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Common.Activity",
		"value": "Development"
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Scheduling.RemainingWork",
		"value": 2
  	},
	{
		"op": "add",
		"path": "/fields/Microsoft.VSTS.Scheduling.OriginalEstimate",
		"value": 2
  	},
	{
		"op": "add",
		"path": "/fields/System.AssignedTo",
		"value": "{{teamMemberEmail}}"
  	},
    {
        "op": "replace",
        "path": "/fields/System.Tags",
        "value": "Tag1; Tag2; TAG5"
    }
]
###

POST {{baseUrl}}/wit/workitems/$User%20Story?{{apiVersionParam}}
Authorization: Basic PAT {{token}}
Content-Type: application/json-patch+json

[
	{
		"op": "add",
		"path": "/fields/System.Title",
		"value": "test 2"
  	},
	{
		"op": "add",
		"path": "/fields/System.IterationPath",
		"value": "{projectName}\\Iteration 1"
  	}
]